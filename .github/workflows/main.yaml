name: 'build'

on:
  push:
    branches:
      - 'master'

env:
  extensions: 'json'
  cache-version: '1'
  composer-version: 'v1'
  composer-install: 'composer update --no-interaction --no-progress --no-suggest --prefer-dist --prefer-stable'

jobs:
  coding_style:
    name: 'Coding style'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - name: 'PHP setup'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          coverage: 'none'

      - name: 'Coding style'
        shell: bash
        run: bin/cs

  php_stan:
    name: 'PHP Stan'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - name: 'PHP setup'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          coverage: 'none'

      - name: 'PHP Stan'
        shell: bash
        run: bin/stan

  tests:
    name: 'Tests'
    runs-on: '${{ matrix.operating-system }}'

    strategy:
      matrix:
        php-version: [ '7.1', '7.2', '7.3', '7.4', '8.0' ]
        operating-system: [ 'ubuntu-latest' ]
        composer-args: [ '' ]
        include:
          - php-version: '7.1'
            operating-system: 'ubuntu-latest'
            composer-args: '--prefer-lowest'
      fail-fast: false

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - name: 'PHP setup'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '${{ matrix.php-version }}'
          coverage: 'none'

      - name: 'Run tests'
          run: |
            vendor/bin/tester tests -c tests/php.ini --coverage coverage.xml --coverage-src src
            bash <(curl -s https://codecov.io/bash) -t ac780c13-20d5-4325-b8bc-e6f6f8c33c95

      - name: 'Upload log if failure'
        uses: actions/upload-artifact@v1
        if: failure()
        with:
          name: 'log'
          path: 'log'
